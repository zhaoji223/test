[TOC]

![version](https://img.shields.io/badge/version-v1.0.3-brightgreen)

# 神策自定义埋点新方案

## 方案背景

目前线上的神策自定义埋点，常用的事件属性有 event, FileName, FileValue 等。其中 event 表示事件类型，FileName, FileValue 根据事件类型，存储不同的自定义属性。

已有的埋点方案（称作 v1 ）可以满足大部分页面的简单需求，却不能满足详情页等复杂页面的数据需求。比如，详情页的按钮点击事件，往往需要同时上传当前项目的状态（进行中还是已结束），当前用户的捐款情况（首捐或者复捐），页面灰度状态（一步版，两步版还是三步版），当前用户的分享状态（是否已分享），当前用户与发起人的关系（是否亲友）等诸多条件。

现行的做法是将所有状态变量排列组合，将组合的每个元素对应一个枚举值，存入 FileName 或 FileValue 中。这种做法有以下弊端：

1. 枚举值数量巨大。由于枚举值的数量是状态变量的乘积，数据需求越细分，埋点数量增长越快。
2. 重复劳动多。每次有新的数据需求，都需要前端重新埋点。
3. 扩展性差。产品需求的小的微调，有可能导致埋点内容的较大改动。

## 方案内容

通过现有的神策自定义埋点进行梳理汇总，新的埋点规范与线上数据向后兼容。

### 埋点事件规范

1. 每个页面有唯一的标识符 `page_key`（注意与 `pageid` 区分），比如详情页是 `H5_WA_DetailPage`。该字段由产品经理提供。
1. 每个页面元素有唯一标识符 `element_key`。比如 `Button_Logo`。该字段由产品经理提供。
1. 每个弹窗都有唯一的标识符 `pop_key`。比如 `H5_Pop_WA_Back_One`。该字段由产品经理提供。
1. 点击元素时，上报 `FileClick` 事件，同时设置 `{ FileName:element_key , FileValue:page_key }`。
1. 输入框失焦时，上报 `{{ page_key }}` 事件，同时设置 `{ FileName:element_key, FileValue:输入框的值 }`。
1. 当出现弹框时，上报 `PopupTrack` 事件，同时设置 `{ FileName:pop_key, FileValue: page_key }`。
1. 所有的自定义事件包含 `ExtraInfo` 属性，其中包含每个页面独有的状态对象。详情页状态对象见下文。
1. 所有的自定义事件包含 `$url` 和 `$referrer` 属性，表示当前页面和当前页面的来源。

### 新埋点文档

当提供新的埋点文档时，产品经理只需要提供如下内容：

1. 埋点页面标识符 `page_key`
1. 各弹框标识符 `pop_key`
1. 各元素标识符 `element_key`

### 状态对象

新的埋点方案（称作 v2）使用一个状态对象替换枚举值。以详情页为例，每个自定义埋点事件将包含如下对象：

```js
{
    "donated": 1,       // 是否已捐款
    "manager": 0,       // 是否主态
    "paytype": 1,       // 支付类型 1一步版 2两步版 3全文版
    "shared": 1,        // 是否已转发
    "open": 1,          // 是否展开全文
    "qinyou": 1,        // 是否亲友
    "prostate": 8192,   // 项目状态 8192进行中 512成功
    "qscrnd": 0.1,      // 灰度随机数
    "peijuan": 1,       // 配捐状态 0非配捐 1转发配捐 2捐款配捐 3转发+捐款配捐
    "bless": 0,         // 祝福类型 0未送出 1果篮 2纸鹤 3桔灯
}
```

注意，以上状态变量只是作为参考，最新的详情页状态字典请参考[wiki][2]。

### 如何使用 v2?

基于 `v2` 方案，开发了 `sensors-data-utils` 库函数。使用方法如下：

```sh
# 安装私有 npm 包
$ npm install git+https://code.qschou.com/liuz/sensors-data-utils.git#v1.0.3 --save
```

注意：`npm install` 加载私有 npm 包时需要使用 `git+https` 协议。其中的 `#v1.0.3` 表示 tag 标签，当库函数版本升级后，业务方可以更新标签名，升级库函数版本。

```js
import saUtils from 'sensors-data-utils';

// 设定当前页面键值
const pageKey = 'HELLO_WORLD';

// 初始化页面监听事件，用于自动触发 FileClick 事件和输入框的失焦事件
// 必须在页面开始时调用
saUtils.init(pageKey);

// 更新单一变量
saUtils.set('shared', 1);

// 批量更新变量
saUtils.update({
    donated: 0,
    peijuan: 1,
});

// 上报弹框事件
const popKey = 'H5_Pop_WA_Back';
saUtils.popup(popKey);
```

**上报点击事件和输入框失焦事件**

在元素上增加 `data-sa` 属性，将自动触发 `FileClick` 事件和输入框失焦事件。

```html
<div data-sa="hello-world">hello world</div>
<input data-sa="foobar">
```

当元素的 click 事件设置了取消冒泡的选项，比如 `@click.stop`，`sensors-data-utils` 将无法监听到该元素的点击事件。此时，需要手动触发该元素的点击事件。具体代码如下：

```html
<div @click.stop="onClick">Click Me</div>

<script>
    import saUtils from 'sensors-data-utils';
    // ...
    function onClick() {
       // ...
       const elementKey = 'Button_Click';
       saUtils.click(elementKey);
    }
</script>
```

公用组件（比如弹框组件）的点击功能（如关闭按钮），也可以使用 `click()` 方式上报。

**手动触发事件上报**

当数据需求比较特殊，无法使用自动化方案时，也可以手动触发神策事件。方法如下：

```js
import reportAnalytics from './reportAnalytics';

// 获取状态变量字符串
const extraInfoStr = saUtils.toString();
reportAnalytics('custom-event-name', {
    FileName: 'foo',
    FileValue: 'bar',
    ExtraInfo: extraInfoStr,
});

// 获取状态对象，便于进一步修改对象属性
const extraInfo = saUtils.valueOf();
reportAnalytics('shareEvent', {
    FileName: 'a',
    FileValue: 'b',
    ExtraInfo: JSON.stringify({
        ...extraInfo,
        foo: 42,
        bar: 'baz',
    });
})
```

### 注意事项

⚠️ 目前 `sensors-data-utils` 不包含神策 JS-SDK 的引入和设置，无法独立完成埋点上报，需要配合主站的 `tracking.init()` 使用。

## 相关页面

1. [神策埋点方案 v2][1]，包含新方案涉及的页面状态字典，埋点数据等。
1. [详情页状态字典][2]

[1]: https://qscwiki001.qingsongchou.com/pages/viewpage.action?pageId=46179735 "神策埋点方案 v2"
[2]: https://qscwiki001.qingsongchou.com/pages/viewpage.action?pageId=48169961 "详情页状态字典"
